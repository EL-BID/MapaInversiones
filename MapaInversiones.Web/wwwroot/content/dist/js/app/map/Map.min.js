define(["lib/mvc/Observable","./Polygon","./Pushpin","app/network/Services","./MapState","./ListView"],function(n,t,i,r,u){"use strict";function f(n){function ot(){o=new Microsoft.Maps.Map(n,{credentials:"Ah7mafuzHQjBcBfHXRNcyucmUVbzczI7SPzmWvoXhIxnDH-4fUcSKiPpR2kcDZLn",zoom:b,showMapTypeSelector:!1,center:tt,enableSearchLogo:!1,enableClickableLogo:!1,mapTypeId:Microsoft.Maps.MapTypeId.road}),Microsoft.Maps.Events.addHandler(o,"mousewheel",function(n){return n.handled=!0,!0}),Microsoft.Maps.Events.addHandler(o,"click",function(){f.fireEvent("click",o)}),Microsoft.Maps.Events.addThrottledHandler(o,"viewchangeend",et,600),r.polygons.getDepartments(g("departments")),f.showSpinner(),r.polygons.getRegions(g("regions")),f.showSpinner(),r.polygons.getMunicipalities(g("municipalities")),et(),f.ready=!0,f.fireEvent("ready",f),y=new Microsoft.Maps.EntityCollection}function st(n,i,r){var l,b,u,p,a,k=r?"ge":"geometry",g=r?"c":"coordinates",nt=r?"t":"type",v=r?"p":"properties",w=r?"i":"id",d=i=="regions",o;for(s[i]=s[i]||{},h[i]=new Microsoft.Maps.EntityCollection,c[i]=new Microsoft.Maps.EntityCollection,h[i].setOptions({zIndex:1}),c[i].setOptions({zIndex:2}),y.setOptions({zIndex:9}),p=0;p<n.features.length;p++)if(l=n.features[p],b=l[k][g],l[k][nt]=="MultiPolygon"){for(o=[],a=0;a<b.length;a++)u=ft(b[a],l[v],r,l[v][w],i),u._leftTopPoint&&(o[a]=u,a===0?(o.leftTopPoint=u._leftTopPoint,o.rightBottomPoint=u._rightBottomPoint):(o.leftTopPoint=[Math.min(o.leftTopPoint[0],u._leftTopPoint[0]),Math.min(o.leftTopPoint[1],u._leftTopPoint[1])],o.rightBottomPoint=[Math.max(o.rightBottomPoint[0],u._rightBottomPoint[0]),Math.max(o.rightBottomPoint[1],u._rightBottomPoint[1])])),d&&u.updateColor("rgba("+t.baseRGB+","+e(p/n.features.length)+")"),s[i][l[v][w]]=s[i][l[v][w]]||[],s[i][l[v][w]].push(u),i!=="municipalities"&&h[i].push(u.getPolygon()),c[i].push(u.getInfobox());for(a=0;a<o.length;a++)o[a].setCoordinates(o.leftTopPoint,o.rightBottomPoint)}else u=ft(b,l[v],r,l[v][w],i),d&&u.updateColor("rgba("+t.baseRGB+","+p/n.features.length+")"),s[i][l[v][w]]=u,i!=="municipalities"&&h[i].push(u.getPolygon()),c[i].push(u.getInfobox());f.fireEvent("polygons-initialized",i)}function ft(n,i,r,u,e){var h=ht(i),s=new t(o,{coords:n,content:h.data},r,u,e);Microsoft.Maps.Events.addHandler(s.getPolygon(),"click",function(n){f.fireEvent("click-on-polygon",n)});s.on("selected",function(n,t){f.fireEvent("polygon-selected",n,t)});return s}function ht(n,t){var i,r,u={name:n.name||n.n,projectNumber:0,approvedMoney:0,id:n.id||n.i},f;if((n.type||n.t)=="departamento"){for(t=t||p.departments,r=0;r<t.length;r++)if(i=t[r],i.id===("id"in n?n.id:n.i)){u.approvedMoney=i.approvedMoney,u.projectNumber=i.projectNumber;break}}else if((n.type||n.t)=="region"){for(t=t||p.regions,r=0;r<t.length;r++)if(i=t[r],i.id===("id"in n?n.id:n.i)){u.approvedMoney=i.approvedMoney,u.projectNumber=i.projectNumber;break}}else if(t&&t[0])for(r=t.length;r--;)if(i=t[r],i.id===("id"in n?n.id:n.i)){u.approvedMoney=i.approvedMoney,u.projectNumber=i.projectNumber;break}return{data:u,color:f}}function ct(n,t,i){var r=Microsoft.Maps.LocationRect.fromCorners(n,t);o.setView({bounds:r,zoom:parseInt(i||b,10)})}function et(){var n,t,r=o.getCenter(),f=r.latitude+" "+r.longitude,e=o.getBounds(),i=o.getZoom();(i%1==0&&k!=i||it!==f)&&(k=i,it=f,u.setZoom(k),n=e.getNorthwest(),t=e.getSoutheast(),u.setCorners([[n.latitude,n.longitude],[t.latitude,t.longitude]]))}function g(n){return function(t){st(t,n,!t.type),nt(),f.showSpinner(!1)}}function lt(n){function y(n,i){if(n){var f=n.id,r=i[f];if(r)if(n instanceof t)n.updateInfobox(r);else for(u=n.length;u--;)n[u].updateInfobox(r);else n.updateInfobox(it)}}var c,k=!0,v={length:0},b={length:0},p={length:0},tt,r,u,d,rt="rgba("+t.baseRGB+","+e(0)+")",it={projectNumber:0,approvedMoney:0},l,g=Object.prototype.hasOwnProperty;if(w=[],n.objects)for(d=n.objects.length;d--;)c=n.objects[d],c.type=="municipio"?(v[c.id]=c,v.length+=1):c.type=="departamento"?(b[c.id]=c,b.length+=1):c.type=="region"?(p[c.id]=c,p.length+=1):w.push(new i(c,o,this));if(b.length||p.length){for(l in s.departments)if(g.call(s.departments,l))if(r=s.departments[l],r instanceof t)y(r,b);else for(u=0;u<r.length;u++)y(r[u],b);for(l in s.regions)if(g.call(s.regions,l))if(r=s.regions[l],tt=r.id,c=p[tt],r instanceof t)y(r,p);else for(u=0;u<r.length;u++)y(r[u],p);a=f.actualVisualization(),k=!1}if(v.length&&h.municipalities){h.municipalities.clear();for(l in v)if(g.call(v,l))if(r=s.municipalities[l],r instanceof t)r.generatePolygon(),h.municipalities.push(r.getPolygon()),y(r,v);else if(r instanceof Array)for(u=0;u<r.length;u++)r[u].generatePolygon(),h.municipalities.push(r[u].getPolygon()),y(r[u],v);a="Municipality",k=!1}$("#filter-results .value").html(n.totalProjectsNumber),k&&(a=""),nt()}function nt(){var n;clearTimeout(rt),rt=setTimeout(function(){var t;for(a=="Department"||a=="Region"?(l!="Region"&&l!="Department"||f.actualVisualization()!=l)&&(f.actualVisualization()=="Region"&&h.regions&&(l=f.actualVisualization(),o.entities.clear(),t=!0,o.entities.push(h.regions),o.entities.push(c.regions)),f.actualVisualization()=="Department"&&h.departments&&(l=f.actualVisualization(),o.entities.clear(),t=!0,o.entities.push(h.departments),o.entities.push(c.departments))):a=="Municipality"?l!="Municipality"&&h.municipalities&&(l="Municipality",o.entities.clear(),t=!0,o.entities.push(h.municipalities),o.entities.push(c.municipalities)):l="",y.clear(),n=w.length;n--;)y.push(w[n]);ut||o.entities.remove(y),o.entities.push(y),ut=!1},100)}function at(){u.setListMode(!0)}var o,h={regions:null,departments:null,municipalities:null},s={},p={departments:JSON.parse(document.body.getAttribute("data-deparmentProjectData")),regions:JSON.parse(document.body.getAttribute("data-regionProjectData"))},c={regions:null,departments:null,municipalities:null},tt=new Microsoft.Maps.Location(4.3344012216447965,-77.76142578125),b=6,a,k=5,it,l,w=[],y,f=this,rt,d=$("<div>",{"class":"loader"}).appendTo($(".map-container")[0]),v=[],ut=!0;f.actualVisualization=ko.observable("Department"),a=f.actualVisualization(),f.showSpinner=function(n){n!==!1&&v.push(1),n===!1&&v.length<2?(d.fadeOut(),v=[]):n===!1?v.pop():d.fadeIn()},f.hideSpinner=function(){v.length<2?(d.fadeOut(),v=[]):v.pop()};u.on("projects-loaded",lt.bind(this));u.on("projects-loaded",f.hideSpinner.bind(f));u.on("loading-projects",f.showSpinner.bind(f));u.on("load-projects-aborded",f.hideSpinner.bind(f));$("#filter-results button").click(at),ot(),f.isRegion=ko.computed(function(){return f.actualVisualization()=="Region"},f.actualVisualization),f.toggleMode=function(){var t,i=0,n,r;for(f.actualVisualization(f.actualVisualization()=="Region"?"Department":"Region"),nt(),t=f.actualVisualization()=="Department"?p.departments:p.regions,n=0;n<t.length;n++)r=t[n],i=Math.max(i,r.approvedMoney)},ko.applyBindings(f,$("#map-view-options .change-view-mode")[0]),this.zoomToTerritory=function(n,t){var e,r,c,i,u,h;if(t.length){if(e=n=="municipio"?s.municipalities:n=="departamento"?s.departments:s.regions,!e){this.on("polygons-initialized",function(i){i==n&&f.zoomToTerritory(n,t)});return}if(i=e[t[0].value],i){for(i instanceof Array&&(i=i[0]),r=i.getCoordinates(),h=1;h<t.length;h++)i=e[t[h].value],u=i.getCoordinates(),i instanceof Array&&(i=i[0]),r=[{latitude:Math.min(u[0].latitude,r[0].latitude),longitude:Math.min(u[0].longitude,r[0].longitude)},{latitude:Math.max(u[1].latitude,r[1].latitude),longitude:Math.max(u[1].longitude,r[1].longitude)}];c=new Microsoft.Maps.LocationRect.fromCorners(new Microsoft.Maps.Location(r[0].latitude,r[0].longitude),new Microsoft.Maps.Location(r[1].latitude,r[1].longitude)),o.setView({bounds:c})}}},this.zoomToColombia=function(){o.setView({center:tt,zoom:b,animate:!1})},this.hideInfoboxes=function(){var n,t,i;for(t in c)if(c.hasOwnProperty(t)&&(n=c[t],n))for(i=n.getLength();i--;)n.get(i).hide()},this.panTo=ct,this.viewGroupList=function(n){u.setCorners([[n.latitude,n.longitude],[n.latitude,n.longitude]],!0)};u.on("projects-list-loaded",this.hideInfoboxes.bind(this))}function e(n){return(.15+.5*n).toFixed(2)}return f.prototype=new n,f});
//@ sourceMappingURL=Map.min.js.map