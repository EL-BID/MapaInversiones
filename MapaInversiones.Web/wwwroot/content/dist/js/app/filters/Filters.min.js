define(["lib/mvc/Observable","app/network/Services","./FilterGroup","../map/MapState","app/utils/Utils","app/infographic/Infographic"],function(n,t,i,r,u,f){var e;return new Class(n,{project:"/proyectos",resources:"/recursos",initialize:function(){function i(){return this.visible=ko.observable(!0),this.toggleVisible=function(t){if(typeof t!="boolean"||t!==this.visible())return typeof t=="boolean"?this.visible(t):this.visible(!this.visible()),n.toggleControl(this.visible()),t instanceof Event&&(t.stopPropagation?t.stopPropagation():typeof t!="boolean"&&(window.event.cancelBubble=!0)),!1},!1}function u(){function t(){n.notifyNewSearch()}this.query=ko.observable(""),this.query.subscribe(t),this.search=t}var n=this;this.activated=!1,this.mode=null,this.elems={},this.elems.root=$("#controls"),this.elems.search=$("#search"),this.elems.filtersProjects=$("#filters-projects"),this.elems.filtersResources=$("#filters-resources"),this.elems.filterResults=$("#filter-results"),this.elems.resetFiltersWrapper=$("#reset-filters-wrapper"),this.elems.resetFilters=$("#reset-filters"),this.elems.initLink=$("#header .logo, #header .inicio, #footer .inicio"),this.elems.share=$("#share"),setTimeout(function(){t.filters.forProjects().done(n.initializeModels.bind(n))},0),setTimeout(function(){n.fireEvent("loading-filters")},20);r.on("projects-loaded",this.updateStatistics.bind(this));this.searchQuery=new u,this.viewMode=new i,this.resetFilters=ko.observable(!1),ko.applyBindings(this.viewMode,$("#toggle-controls")[0]),ko.applyBindings(this.searchQuery,$("#search")[0]);this.elems.initLink.on("click",this.unselectAll.bind(this))},activate:function(n,t){var i=this.elems.root,r=i.find(".actions"),u=[];(this.filtersProjects&&(u=this.filtersProjects().filter(function(n){return n.active()})),t||n!==this.project||u.length!==1||u[0].parameter!=="periods")&&(n===this.project||n===this.resources?(i.addClass("tabs-mode"),i.find(".statistics").addClass("small"),i.find(".intro").hide(),$("#filter-results").show(),this.elems.search.show(),this.elems.share.show()):(i.removeClass("tabs-mode"),i.find(".statistics").removeClass("small"),i.find(".intro").show(),$("#filter-results").hide(),this.elems.search.hide(),this.elems.share.hide()),$("#projects-list-view").hide(),$("#map-view").show(),$("#controls").removeClass("list-mode"),n===this.project?(this.mode=this.project,this.elems.filtersResources.hide(),this.elems.filtersProjects.show(),r.find(".search-resources").addClass("inactive").siblings().removeClass("inactive")):n===this.resources?(this.mode=this.resources,this.elems.filtersProjects.hide(),this.elems.filtersResources.show(),r.find(".search-projects").addClass("inactive").siblings().removeClass("inactive")):(this.mode=null,this.elems.filtersResources.hide(),this.elems.filtersProjects.hide(),r.find("a").removeClass("inactive")))},toggleControl:function(n){return this.activated=!0,n?this.elems.root.animate({marginLeft:0,left:0}):(this.elems.root.animate({marginLeft:0,left:-350}),this.hideAllFilters(),r.listMode&&r.setListMode(!1)),!1},initializeModels:function(n){var r=n.filters,u=[],t=this;r&&setTimeout(function(){for(var o=r.length,e=0,n;e<o;e++){n=new i(r[e]),u.push(n);n.on("activate-options-related",t.activateOptionsRelated.bind(t));if(n.parameter.match(/(region)|(departamento)|(municipio)/))n.on("activated-by-user",t.activatedByUser.bind(t));n.on("option-activated",t.notifyNewSearch.bind(t));n.on("filters-gonna-show",t.checkActivated.bind(t));if(n.parameter=="periods"||n.parameter=="periodos"){ko.applyBindings(n,$("#map-select-period")[0]),ko.applyBindings(n,$("#info-select-period")[0]),ko.applyBindings(n,$("#filters-stats-info")[0]);n.on("option-activated",function(n){f.reloadGraphs(n.getQuery())})}}t.filtersProjects=ko.observableArray(u),setTimeout(function(){ko.applyBindings(t,t.elems.filtersProjects[0]),ko.applyBindings(t,t.elems.resetFilters[0]),t.fireEvent("filters-loaded")},0)},0)},activateOptionsRelated:function(n){function u(i){return i.parameter===n[t].type}for(var r,i,t=0;t<n.length;t++)r=this.filtersProjects().filter(u),i=r[0].getOptionByValue(n[t].id),i&&i.setActive(!0,!0)},activatedByUser:function(n,t){this.fireEvent("territory-activated",n,t)},notifyNewSearch:function(){var n=this;clearTimeout(e),e=setTimeout(function(){var i="",u=n.filtersProjects(),t=0,f=[];for(r.setQuery(n.searchQuery.query()),n.resetFilters(!1);t<u.length;t++)u[t].active()&&(f.push(u[t]),i+=u[t].getQuery()+"&",n.resetFilters(!0));f.length||n.searchQuery.query()?n.elems.resetFiltersWrapper.show():n.elems.resetFiltersWrapper.hide(),i=i.replace(/&$/,""),r.setFiltersString(i)},0)},unselectAll:function(n){var t,i;if(this.filtersProjects){for(n!==!0&&this.fireEvent("filters-reseted"),t=this.filtersProjects(),i=t.length;i--;)t[i].disActive();$("html, body").animate({scrollTop:0},200),this.searchQuery.query(""),this.hideAllFilters()}},updateStatistics:function(n){var t=this.elems.root;this.fireEvent("loaded-filters"),this.activated||(t.animate({marginLeft:0,left:0}),this.activated=!0),t.find("#collected-money").html(parseInt(n.collectedMoney).toCurrency()),t.find("#approved-money").html(parseInt(n.approvedMoney).toCurrency()),t.find("#approved-projects").html(n.approvedProjects),t.find("#total-sources").html(parseInt(n.approvedMoneyTotal).toCurrency())},hideAllFilters:function(){var n,t,i;if(this.filtersProjects)for(n=this.filtersProjects(),i=n.length;i--;)t=n[i],t.visible()&&t.hide()},checkActivated:function(n){var r=this.filtersProjects(),t,u=[],i;for(this.fireEvent("filters-gonna-show",n),i=r.length;i--;)t=r[i],t.active()&&u.push(t),t.visible()&&t.parameter!=n.parameter&&t.hide();n.sortOptionsBy(u)},select:function(n,t){var e=!!(window.history&&window.history.pushState),r,i,u,f;if(n=="query")this.searchQuery.query(t);else for(r=this.filtersProjects(),u=r.length;u--;)if(i=r[u],i.parameter===n)if(t instanceof Array)for(f=t.length;f--;)i.selectOption(t[f]);else i.selectOption(t)}})});
//@ sourceMappingURL=Filters.min.js.map